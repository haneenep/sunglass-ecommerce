<%- include('../layout/userProfileHead') -%>
<%- include('../layout/userHeaderNav') %>

<style>
.custom-modal {
    display: none;
    position: fixed;
    z-index: 1050;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
    padding-top: 60px;
}

.custom-modal-content {
    background-color: #fff;
    margin: 5% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 40%;
    border-radius: 8px;
}

.custom-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 10px;
    border-bottom: 1px solid #ddd;
}

.custom-modal-header h5 {
    margin: 0;
}

.custom-modal-header button {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
}

.custom-modal-body {
    padding: 10px 0;
}

.custom-modal-footer {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    padding-top: 10px;
    border-top: 1px solid #ddd;
}
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-3" id="sidebar">
            <div class="sidebar" style="margin-left: 125px;">
                <% if(locals.user){ %>
                <h2>Account <br> <p> <%= user.name.toUpperCase() %></p><hr></h2>
                <% } %>
                <ul class="sidebar-nav">
                    <li><a href="/userProfile">My Account</a></li>
                    <li><a href="/orders">My Orders</a></li>
                    <li><a href="#">My Wishes</a></li>
                    <li><a href="#">My Wallet</a></li>
                    <li><a href="/shipAddress"></i> My Shipping Addresses</a></li>
                    <li><a href="/logout"style="margin-right: 0;" id="logoutButton" style="color: red;" onclick="confirmLogout(event)">Sign Out</a></li>
                </ul>
            </div>
        </div>
        <div class="col-md-9">
            <h2 class="my-4">Order Details</h2>
            <div class="card mb-4">
                <div class="card-body"> 
                    <p class="card-text"><strong>Order Date:</strong> <%= new Date(order.createdAt).toLocaleString('en-US', { timeZone: 'Asia/Kolkata' }) %></p>
                    <p class="card-text"><strong>Status:</strong>
                        <span class="badge rounded-pill p-2 text-uppercase px-3"
                            style="background-color : <%= order.selectedProduct.status === 'Order Delivered' ? 'rgb(40 167 69 / .11)' : order.selectedProduct.status === 'pending' ? 'rgb(255 193 7 / .11)' : 'rgb(220 53 69 / .11)' %>;
                            color: <%= order.selectedProduct.status === 'Order Delivered' ? '#28a745 !important' : order.selectedProduct.status === 'pendings' ? '#ffc107 !important' : '#dc3545 !important' %>">
                            <%= order.selectedProduct.status %>
                        </span>
                    </p>
                </div>
            </div>

            <h4>Product</h4>
            <hr>
            <div class="product-details mb-3">
                <div class="row">
                    <div class="col-md-2">
                        <img src="<%= order.selectedProduct.productId.images[0] %>" alt="<%= order.selectedProduct.productId.productName %>" class="order-image img-fluid" style="border-radius: 0px 3pc; margin-top: 20px; margin-left: 10px;">
                    </div>
                    <div class="col-md-10">
                        <h5><%= order.selectedProduct.productId.productName %></h5>
                        <p><strong>Quantity:</strong> <%= order.selectedProduct.quantity %></p>
                        <p><strong>Price:</strong> ₹<%= order.selectedProduct.price %></p>
                        <p><strong>Total:</strong> ₹<%= order.selectedProduct.price * order.selectedProduct.quantity %></p>
                        <% if (order.selectedProduct.status) { %>
                            <p><strong>Status:</strong> <span class="status-<%= order.selectedProduct.status.toLowerCase() %>"><%= order.selectedProduct.status %></span></p>
                        <% } %>
                        <% if (order.selectedProduct.deliveredOn) { %>
                            <p><strong>Delivered on:</strong> <%= new Date(order.selectedProduct.deliveredOn).toLocaleString('en-US', { timeZone: 'Asia/Kolkata' }) %></p>
                        <% } %>
                        <!-- New section for action buttons -->
                        <div class="mt-3 text-end">
                            <% if (order.selectedProduct.status === 'Order Delivered') { %>
                                <a href="/invoice/<%= order._id %>" class="btn btn-outline-primary me-2">Invoice</a>
                                <button class="btn btn-outline-warning me-2" onclick="openModal()">Return</button>
                                <a href="/products/<%= order.selectedProduct.productId._id %>" class="btn btn-outline-success">Buy Again</a>
                                <% }else if(order.selectedProduct.status === 'Return Requested'){ %>
                                    <a href="/products/<%= order.selectedProduct.productId._id %>" class="btn btn-outline-success">Buy Again</a>
                                <% }else if(order.selectedProduct.status === 'Return Approved' || order.selectedProduct.status === 'Return Rejected' || order.selectedProduct.status === 'canceled'){ %>
                                <a href="/products/<%= order.selectedProduct.productId._id %>" class="btn btn-outline-success">Buy Again</a>
                                <% } else if (order.selectedProduct.status !== 'cancelled') { %>
                                <a href="/products/<%= order.selectedProduct.productId._id %>" class="btn btn-outline-success">Buy Again</a>
                                <button class="btn btn-outline-danger" onclick="confirmCancel('<%= order._id %>', '<%= order.selectedProduct._id %>')">Cancel Order</button>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>

            <% if (order.otherItems && order.otherItems.length > 1) { %>
                <div class="card mt-4">
                    <div class="card-body">
                        <h5 class="card-title">Other items in this order</h5>
                        <p class="card-text">Order ID # <%= order.orderId %></p><hr>
                        <% order.otherItems.forEach(function(item) { %>
                            <div class="other-item mb-3">
                                <div class="row">
                                    <div class="col-md-2">
                                        <img src="<%= item.image %>" alt="<%= item.name %>" class="order-image img-fluid" style="border-radius: 0px 3pc; margin-top: 30px; margin-left: 20px;"><hr>
                                    </div>
                                    <div class="col-md-10">
                                        <p><strong><%= item.name %></strong></p>
                                        <p><strong>Quantity:</strong> <%= item.quantity %></p>
                                        <p><strong>Price:</strong> ₹<%= item.price * item.quantity %></p>
                                        <a href="/orderDetails/<%= order._id %>?productId=<%= item._id %>" class="btn btn-sm btn-outline-dark">View Details</a><hr>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    </div>
                </div>
            <% } %>

            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">Delivery Address</h5>
                    <p class="card-text"><%= order.address.fullName %></p>
                    <p class="card-text"><%= order.address.locality %>, <%= order.address.city %></p>
                    <p class="card-text"><%= order.address.state %> - <%= order.address.pincode %></p>
                    <p class="card-text">Phone: <%= order.address.phoneNumber %></p>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">Order Summary</h5>
                    <p class="card-text"><strong>Subtotal: </strong><span style="color: red;">₹<%= order.subtotal %></span></p>
                    <% if(order.couponDiscount){ %>
                    <p class="card-text"><strong>Coupon Discount: </strong>-₹<%= order.couponDiscount %></p>
                    <% } %>
                    <p class="card-text"><strong>Shipping: </strong><span style="color: green;">Free</span></p>
                    <p class="card-text"><strong>Total:</strong> ₹<%= order.totalAmount %></p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="customModal" class="custom-modal">
    <div class="custom-modal-content">
        <div class="custom-modal-header">
            <h5>Return Request</h5>
            <button onclick="closeModal()">&times;</button>
        </div>
        <div class="custom-modal-body">
            <div class="form-group">
                <label for="reason">Select Return Reason</label>
                <select class="form-control" id="reason" required>
                    <option value="Defective Product">Defective Product</option>
                    <option value="Wrong Product">Wrong Product</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label for="description">Description</label>
                <textarea class="form-control" id="description" rows="4" required></textarea>
            </div>
            <div class="form-group mt-3 text-end">
                <button class="btn btn-primary" onclick="submitReturnRequest()">Return</button>
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>
</div>


<script>
    function openModal() {
        document.getElementById('customModal').style.display = 'block';
    }
    
    function closeModal() {
        document.getElementById('customModal').style.display = 'none';
    }
    
    function submitReturnRequest() {
        const reason = document.getElementById('reason').value;
        const description = document.getElementById('description').value;
    
        if (!reason || !description) {
            Swal.fire({
                text: 'Please fill in all fields.',
                icon: 'warning',
                timer: 3000,
                showConfirmButton: false
            });
            return;
        }
    
        Swal.fire({
            title: 'Submitting return request...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
    
        fetch(`/return/<%= order._id %>/<%= order.selectedProduct._id %>`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ reason, description })
        })
        .then(response => response.json())
        .then(data => {
            Swal.close();
            closeModal();
            if (data.success) {
                Swal.fire({
                    text: data.message,
                    icon: 'success',
                    timer: 3000,
                    showConfirmButton: false
                });
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                Swal.fire({
                    text: data.error,
                    icon: 'error',
                    timer: 3000,
                    showConfirmButton: false
                });
            }
        })
        .catch(error => {
            Swal.close();
            console.error('Error:', error);
            Swal.fire({
                text: 'An error occurred. Please try again.',
                icon: 'error',
                timer: 3000,
                showConfirmButton: false
            });
        });
    }
    
    function confirmCancel(orderId, productId) {
        Swal.fire({
            title: 'Are you sure?',
            text: "Do you really want to cancel this order?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, cancel it!'
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    title: 'Canceling order...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
    
                fetch(`/cancel-order/${orderId}/${productId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    Swal.close();
                    if (data.success) {
                        Swal.fire({
                            text: 'Order has been cancelled.',
                            icon: 'success',
                            timer: 3000,
                            showConfirmButton: false
                        });
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        Swal.fire({
                            text: data.error,
                            icon: 'error',
                            timer: 3000,
                            showConfirmButton: false
                        });
                    }
                })
                .catch(error => {
                    Swal.close();
                    console.error('Error:', error);
                    Swal.fire({
                        text: 'An error occurred. Please try again.',
                        icon: 'error',
                        timer: 3000,
                        showConfirmButton: false
                    });
                });
            }
        });
    }
    </script>
    

<%- include('../layout/userFooterNav') %>
<%- include('../layout/userFoot') %>
